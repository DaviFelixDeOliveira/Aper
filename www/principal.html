<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="css/style.css">
        <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
        <script src="components/supabase.min.js"></script>
    </head>
    <body>
        <div class="popup-overlay" id="popup-overlay"></div>
        <div class="popup-confirmacao">
            <label class="popup-titulo-confirmacao" id="popup-titulo-confirmacao"></label>
            <div class="popup-confirmacao-botoes">
                <button class="popup-confirmacao-botao" id="popup-confirmacao-confirmar">
                    Sim
                </button>
                <button class="popup-confirmacao-botao" id="popup-confirmacao-cancelar">
                    Cancelar
                </button>
            </div>
        </div>
        <div id="conteudo"></div>
        <!-- Barra de navegação -->
        <div class="navbar" id="navbar">
            <div class="nav-item ni-ativo" id="navbar-inicio"></div>
            <div class="nav-item" id="navbar-pesquisa"></div>
            <div class="nav-item" id="navbar-jogo"></div>
            <div class="nav-item" id="navbar-perfil"></div>
        </div>
        <!-- SCRIPTS NA ORDEM CORRETA -->
        <script src="cordova.js"></script>
        <script src="components/conexao.js"></script>
        <script src="components/bloqueio-externo.js"></script>
        <script src="components/funcoes.js"></script>
        <script>
      //HISTÓRICO DE NAVEGAÇÃO
      let historySPA = JSON.parse(sessionStorage.getItem("historySPA") || "[]");
      let paginaCarregada = false;

      // DEFINE carregarPagina GLOBALMENTE ANTES DE QUALQUER USO
      window.carregarPagina = function (url, callback) {
        // MARCA QUE UMA PÁGINA FOI CARREGADA
        paginaCarregada = true;

        console.log("carregarPagina chamado para:", url);
        const conteudo = document.getElementById("conteudo");

        let historySPA = JSON.parse(
          sessionStorage.getItem("historySPA") || "[]"
        );
        const ultimaPagina = historySPA[historySPA.length - 1];

        // CORREÇÃO: SÓ CONSIDERA "JÁ CARREGADA" SE HOUVER CONTEÚDO VISÍVEL
        const temConteudoVisivel = conteudo.querySelector(".slide-in") !== null;

        if (ultimaPagina === url && temConteudoVisivel) {
          console.log("Página já carregada e visível:", url);
          if (callback) {
            const containerExistente = conteudo.querySelector(
              ".slide-in:last-child"
            );
            if (containerExistente) {
              console.log("Re-executando callback para página existente");
              callback(containerExistente);
            } else {
              console.log("Executando callback sem container");
              callback();
            }
          }
          return;
        }

        // SE CHEGOU AQUI, PRECISA CARREGAR A PÁGINA
        console.log("Carregando página:", url);

        fetch(url)
          .then((res) => {
            if (!res.ok) {
              throw new Error(`Erro HTTP: ${res.status}`);
            }
            return res.text();
          })
          .then((html) => {
            const slideContainer = document.createElement("div");
            slideContainer.classList.add("slide-in");
            slideContainer.innerHTML = html;

            conteudo.appendChild(slideContainer);

            //ATUALIZA HISTÓRICO
            historySPA.push(url);
            sessionStorage.setItem("historySPA", JSON.stringify(historySPA));

            //ATUALIZA NAVBAR
            atualizarNavbar(url);

            setTimeout(() => {
              conteudo
                .querySelectorAll(".slide-in:not(:last-child)")
                .forEach((el) => el.remove());
              if (callback) {
                callback(slideContainer);
              }
            }, 400);
          })
          .catch((error) => {
            console.error("Erro ao carregar página:", error);
          });
      };

      //FUNÇÃO PARA ATUALIZAR NAVBAR COM BASE NA PÁGINA
      function atualizarNavbar(pagina) {
        const navItems = document.querySelectorAll(".nav-item");
        navItems.forEach((item) => item.classList.remove("ni-ativo"));

        if (pagina.includes("inicio.html")) {
          document.getElementById("navbar-inicio").classList.add("ni-ativo");
        } else if (pagina.includes("pesquisa.html")) {
          document.getElementById("navbar-pesquisa").classList.add("ni-ativo");
        } else if (pagina.includes("jogos.html")) {
          document.getElementById("navbar-jogo").classList.add("ni-ativo");
        } else if (pagina.includes("perfil.html")) {
          document.getElementById("navbar-perfil").classList.add("ni-ativo");
        }
        console.log("Navbar atualizada para:", pagina);
      }

      //FUNÇÃO PARA MOSTRAR POPUP DE CONFIRMAÇÃO
      function mostrarPopupConfirmacao(
        mensagem,
        callbackConfirmar,
        callbackCancelar
      ) {
        const popupOverlay = document.getElementById("popup-overlay");
        const popupConfirmacao = document.querySelector(".popup-confirmacao");
        const popupTitulo = document.getElementById("popup-titulo-confirmacao");
        const btnConfirmar = document.getElementById(
          "popup-confirmacao-confirmar"
        );
        const btnCancelar = document.getElementById(
          "popup-confirmacao-cancelar"
        );

        popupTitulo.textContent = mensagem;

        //Mostra o popup
        popupOverlay.style.display = "flex";
        popupConfirmacao.style.display = "flex";
        popupConfirmacao.style.opacity = "1";

        //Remove eventos anteriores
        btnConfirmar.replaceWith(btnConfirmar.cloneNode(true));
        btnCancelar.replaceWith(btnCancelar.cloneNode(true));

        //Get new references after clone
        const newBtnConfirmar = document.getElementById(
          "popup-confirmacao-confirmar"
        );
        const newBtnCancelar = document.getElementById(
          "popup-confirmacao-cancelar"
        );

        //Configura novos eventos
        newBtnConfirmar.onclick = function () {
          esconderPopupConfirmacao();
          if (callbackConfirmar) callbackConfirmar();
        };

        newBtnCancelar.onclick = function () {
          esconderPopupConfirmacao();
          if (callbackCancelar) callbackCancelar();
        };
      }

      //FUNÇÃO PARA ESCONDER POPUP
      function esconderPopupConfirmacao() {
        const popupOverlay = document.getElementById("popup-overlay");
        const popupConfirmacao = document.querySelector(".popup-confirmacao");

        popupOverlay.style.display = "none";
        popupConfirmacao.style.display = "none";
        popupConfirmacao.style.opacity = "0";
      }

      //FUNÇÃO PARA CONFIGURAR BOTÃO VOLTAR
      function configurarBotaoVoltar() {
        document.addEventListener(
          "deviceready",
          function () {
            document.addEventListener(
              "backbutton",
              function (e) {
                e.preventDefault();
                console.log("Botão voltar pressionado");
                window.voltarPagina();
              },
              false
            );
          },
          false
        );
      }

      //FUNÇÃO PARA CARREGAR PÁGINA INICIAL AUTOMATICAMENTE
      function carregarPaginaInicialAutomaticamente() {
        if (!paginaCarregada) {
          console.log(
            "Nenhuma página carregada após 2 segundos. Carregando página inicial automaticamente..."
          );
          carregarPaginaInicial();
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        let usuarioLocal = localStorage.getItem("usuario_id");

        //INICIA TIMEOUT PARA CARREGAMENTO AUTOMÁTICO
        setTimeout(carregarPaginaInicialAutomaticamente, 2000);

        //VERIFICA se supabase existe
        if (typeof window.supabase === "undefined") {
          console.error("Supabase não carregado!");
          setTimeout(() => {
            if (typeof window.supabase !== "undefined") {
              carregarPaginaInicial();
            } else {
              console.error("Supabase ainda não carregado após timeout");
            }
          }, 1000);
          return;
        }

        const { data: sessionData } = await window.supabase.auth.getSession();
        const sessaoSupabase = sessionData?.session;

        if (!usuarioLocal && !sessaoSupabase) {
          window.location.href = "logincadastro.html";
          return;
        }

        // VERSÃO SIMPLIFICADA
        if (sessaoSupabase) {
          const user = sessaoSupabase.user;
          const { data: profileData } = await supabase
            .from("profiles")
            .select("name")
            .eq("id", user.id)
            .single();

          localStorage.setItem("usuario_id", user.id);
          localStorage.setItem(
            "usuario_nome",
            profileData?.name || user.user_metadata.nome || "Usuário"
          );
          localStorage.setItem("usuario_email", user.email);
          localStorage.setItem(
            "usuario_foto",
            user.user_metadata.avatar_url || ""
          );
        }

        //INICIALIZA HISTÓRICO SE ESTIVER VAZIO
        if (historySPA.length === 0) {
          historySPA.push("paginas/inicio.html");
          sessionStorage.setItem("historySPA", JSON.stringify(historySPA));
          atualizarNavbar("paginas/inicio.html");
        }

        //CARREGA A PÁGINA INICIAL APÓS LOGIN
        carregarPaginaInicial();

        //CONFIGURA BOTÃO VOLTA DO ANDROID
        configurarBotaoVoltar();
      });

      function carregarPaginaInicial() {
        console.log("Carregando página inicial...");
        if (typeof window.carregarPagina === "function") {
          paginaCarregada = true;
          window.carregarPagina("paginas/inicio.html", function () {
            console.log("Página inicial carregada, chamando initInicio...");
            if (typeof initInicio === "function") {
              initInicio();
            } else {
              console.error("initInicio não encontrado");
            }
          });
        } else {
          console.error("carregarPagina não está disponível");
        }
      }

      $(document).ready(function () {
        const conteudo = $("#conteudo");
        const navItems = $(".nav-item");

        window.voltarPagina = function () {
          let historySPA = JSON.parse(
            sessionStorage.getItem("historySPA") || "[]"
          );
          console.log("Voltando página. Histórico:", historySPA);

          if (historySPA.length <= 1) {
            mostrarPopupConfirmacao(
              "Deseja sair do aplicativo?",
              function () {
                if (navigator.app) {
                  navigator.app.exitApp();
                }
              },
              function () {
                console.log("Saída do app cancelada");
              }
            );
            return;
          }

          historySPA.pop();
          const paginaAnterior = historySPA[historySPA.length - 1];
          sessionStorage.setItem("historySPA", JSON.stringify(historySPA));

          atualizarNavbar(paginaAnterior);

          const navbar = document.getElementById("navbar");
          if (navbar) navbar.classList.remove("navbar-esconde");

          fetch(paginaAnterior)
            .then((res) => res.text())
            .then((html) => {
              const conteudo = document.getElementById("conteudo");
              const slideContainer = document.createElement("div");
              slideContainer.classList.add("slide-in");
              slideContainer.innerHTML = html;

              conteudo.appendChild(slideContainer);

              setTimeout(() => {
                conteudo
                  .querySelectorAll(".slide-in:not(:last-child)")
                  .forEach((el) => el.remove());

                if (
                  paginaAnterior.includes("inicio.html") &&
                  typeof initInicio === "function"
                ) {
                  initInicio();
                } else if (
                  paginaAnterior.includes("pesquisa.html") &&
                  typeof initPesquisa === "function"
                ) {
                  initPesquisa();
                } else if (
                  paginaAnterior.includes("assistir.html") &&
                  typeof initAssistir === "function"
                ) {
                  const ultimaObra = sessionStorage.getItem("ultimaObra");
                  if (ultimaObra) {
                    const { id, tipo } = JSON.parse(ultimaObra);
                    initAssistir(id, tipo);
                  } else {
                    initAssistir();
                  }
                } else if (
                  paginaAnterior.includes("perfil.html") &&
                  typeof initPerfil === "function"
                ) {
                  initPerfil();
                } else if (
                  paginaAnterior.includes("jogos.html") &&
                  typeof initJogo === "function"
                ) {
                  initJogo();
                } else if (
                  paginaAnterior.includes("listagem.html") &&
                  typeof initListagem === "function"
                ) {
                  initListagem();
                }
              }, 400);
            });
        };

        navItems.on("click", function () {
          const id = $(this).attr("id");

          navItems.removeClass("ni-ativo");
          $(this).addClass("ni-ativo");

          if (id !== "navbar-pesquisa") {
            sessionStorage.removeItem("ultimaPesquisa");
          }

          switch (id) {
            case "navbar-inicio":
              carregarPagina("paginas/inicio.html", function () {
                if (typeof initInicio === "function") initInicio();
              });
              break;
            case "navbar-pesquisa":
              carregarPagina("paginas/pesquisa.html", function () {
                if (typeof initPesquisa === "function") initPesquisa();
              });
              break;
            case "navbar-jogo":
              carregarPagina("paginas/jogos.html", function () {
                if (typeof initJogo === "function") initJogo();
              });
              break;
            case "navbar-perfil":
              carregarPagina("paginas/perfil.html", function () {
                if (typeof initPerfil === "function") initPerfil();
              });
              break;
          }
        });
      });

      
        </script>
    </body>
</html>